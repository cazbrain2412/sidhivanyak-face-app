"use client";

import { useEffect, useState } from "react";

// --------- helpers ----------

// return true if DOB makes age < 18
function isMinor(dobStr) {
  if (!dobStr) return false;
  const dob = new Date(dobStr);
  if (Number.isNaN(dob.getTime())) return false;

  const today = new Date();
  let age = today.getFullYear() - dob.getFullYear();
  const m = today.getMonth() - dob.getMonth();
  if (m < 0 || (m === 0 && today.getDate() < dob.getDate())) {
    age--;
  }
  return age < 18;
}

export default function AdminSupervisorsPage() {
  const [list, setList] = useState([]);
  const [loading, setLoading] = useState(true);

  // form fields
  const [code, setCode] = useState("");
  const [name, setName] = useState("");
  const [mobile, setMobile] = useState("");
  const [email, setEmail] = useState("");
  const [gender, setGender] = useState("");
  const [address, setAddress] = useState("");
  const [dob, setDob] = useState("");
  const [doj, setDoj] = useState("");

  const [aadhar, setAadhar] = useState("");
  const [pan, setPan] = useState("");
  const [pfNumber, setPfNumber] = useState("");
  const [esicNumber, setEsicNumber] = useState("");

  const [bankAccount, setBankAccount] = useState("");
  const [ifsc, setIfsc] = useState("");
  const [bankBranch, setBankBranch] = useState("");

  const [zone, setZone] = useState("");
  const [divisionsSelected, setDivisionsSelected] = useState([]);

  const [department, setDepartment] = useState("");
  const [password, setPassword] = useState("");

  // documents: array of { type, url }
  const [documents, setDocuments] = useState([{ type: "", url: "" }]);

  const [zones, setZones] = useState([]);
  const [divisions, setDivisions] = useState([]);
  const [departments, setDepartments] = useState([]);

  useEffect(() => {
    loadAll();
  }, []);

  async function loadAll() {
    setLoading(true);
    try {
      const s = await fetch("/api/supervisors/list").then((r) => r.json());
      setList(s.supervisors || []);

      const z = await fetch("/api/zones/list").then((r) => r.json());
      setZones(z.zones || []);

      const d = await fetch("/api/divisions/list").then((r) => r.json());
      setDivisions(d.divisions || []);

      const dept = await fetch("/api/departments/list").then((r) => r.json());
      setDepartments(dept.departments || []);
    } finally {
      setLoading(false);
    }
  }

  // --------- Documents handling ----------

  function setDocField(idx, field, value) {
    setDocuments((prev) => {
      const copy = [...prev];
      copy[idx] = { ...copy[idx], [field]: value };
      return copy;
    });
  }

  function addDoc() {
    setDocuments((prev) => [...prev, { type: "", url: "" }]);
  }

  function removeDoc(idx) {
    setDocuments((prev) => prev.filter((_, i) => i !== idx));
  }

  // --------- Create Supervisor ----------

  async function createSupervisor(e) {
    e.preventDefault();

    if (!code.trim() || !name.trim() || !mobile.trim() || !password) {
      alert("Code, Name, Mobile, Password are required.");
      return;
    }

    // DOB validation: must be 18+
    if (dob) {
      const dobDate = new Date(dob);
      if (Number.isNaN(dobDate.getTime())) {
        alert("Please select a valid Date of Birth.");
        return;
      }
      // no future DOB
      if (dobDate > new Date()) {
        alert("Date of Birth cannot be in the future.");
        return;
      }
      if (isMinor(dob)) {
        alert("Supervisor is minor (age < 18). Please enter an 18+ Date of Birth.");
        return;
      }
    }

    const cleanedDocuments = documents
      .map((d) => ({
        type: (d.type || "").trim(),
        url: (d.url || "").trim(),
      }))
      .filter((d) => d.type && d.url);

    const payload = {
      code: code.trim(),
      name,
      mobile,
      password,
      email,
      gender,
      address,
      dob,
      doj,
      aadhar,
      pan,
      pfNumber,
      esicNumber,
      bankAccount,
      ifsc,
      bankBranch,
      zone,
      division,
      department,
      // IMPORTANT: this is now always an array with only filled rows
      documents: cleanedDocuments,
    };

    const res = await fetch("/api/supervisors/create", {
      method: "POST",
      headers: { "Content-Type": "application/json" },
      body: JSON.stringify(payload),
    });

    const j = await res.json();
    if (!res.ok) {
      alert(j.error || "Error creating supervisor");
      return;
    }

    alert("Supervisor created!");
    resetForm();
    loadAll();
  }

  function resetForm() {
    setCode("");
    setName("");
    setMobile("");
    setPassword("");
    setEmail("");
    setGender("");
    setAddress("");
    setDob("");
    setDoj("");
    setAadhar("");
    setPan("");
    setPfNumber("");
    setEsicNumber("");
    setBankAccount("");
    setIfsc("");
    setBankBranch("");
    setZone("");
    setDivisionsSelected([]);
    setDepartment("");
    setDocuments([{ type: "", url: "" }]);
  }

  // --------- Edit / Delete / Assign ----------
async function editSupervisor(code) {
  const newName = prompt("Enter new name:");
  if (!newName) return;

  const payload = {
    code,
    name: newName,
    divisions: selectedDivisions, // ✅ MULTIPLE DIVISIONS
  };

  const res = await fetch("/api/supervisors/update", {
    method: "POST",
    headers: { "Content-Type": "application/json" },
    body: JSON.stringify(payload),
  });

  if (!res.ok) {
    alert("Update failed");
    return;
  }

  alert("Supervisor updated");
  loadAll(); // refresh list
}

  

  async function deleteSupervisor(code) {
    if (!confirm("Are you sure you want to delete this supervisor?")) return;

    const res = await fetch("/api/supervisors/delete", {
      method: "POST",
      headers: { "Content-Type": "application/json" },
      body: JSON.stringify({ code }),
    });

    const j = await res.json();
    if (!res.ok) return alert(j.error || "Delete failed");

    alert("Deleted successfully!");
    loadAll();
  }

  async function assignEmployee(code) {
    const empCode = prompt("Enter employee code to assign:");
    if (!empCode) return;

    const res = await fetch("/api/supervisors/assign", {
      method: "POST",
      headers: { "Content-Type": "application/json" },
      body: JSON.stringify({ supervisorCode: code, employeeCode: empCode }),
    });

    const j = await res.json();
    if (!res.ok) return alert(j.error || "Assign failed");

    alert("Employee assigned successfully!");
  }

  async function bulkAssign(supervisorCode) {
    const input = prompt(
      "Enter multiple employee codes separated by commas\nExample: E001, E002, E003"
    );
    if (!input) return;

    const employeeCodes = input
      .split(",")
      .map((c) => c.trim())
      .filter((c) => c.length > 0);

    if (employeeCodes.length === 0) {
      alert("No valid employee codes entered.");
      return;
    }

    const res = await fetch("/api/supervisors/bulk-assign", {
      method: "POST",
      headers: { "Content-Type": "application/json" },
      body: JSON.stringify({ supervisorCode, employeeCodes }),
    });

    const j = await res.json();
    if (!res.ok) {
      alert(j.error || "Bulk assign failed");
      return;
    }

    alert(`Bulk assign successful! Updated: ${j.updatedCount} employees`);
  }

  // --------- UI ----------

  return (
    <div className="p-4">
      <h1 className="text-2xl font-semibold mb-4">Supervisors</h1>

      {/* CREATE FORM */}
      <section className="bg-white p-4 rounded shadow mb-6">
        <form className="grid grid-cols-3 gap-3" onSubmit={createSupervisor}>
          <div>
            <label>Code *</label>
            <input
              value={code}
              onChange={(e) => setCode(e.target.value)}
              className="border px-2 py-2 w-full rounded"
            />
          </div>

          <div>
            <label>Name *</label>
            <input
              value={name}
              onChange={(e) => setName(e.target.value)}
              className="border px-2 py-2 w-full rounded"
            />
          </div>

          <div>
            <label>Mobile *</label>
            <input
              value={mobile}
              onChange={(e) => setMobile(e.target.value)}
              className="border px-2 py-2 w-full rounded"
            />
          </div>

          <div>
            <label>Password *</label>
            <input
              type="password"
              value={password}
              onChange={(e) => setPassword(e.target.value)}
              className="border px-2 py-2 w-full rounded"
            />
          </div>

          {/* Optional fields */}
          <div>
            <label>Email</label>
            <input
              value={email}
              onChange={(e) => setEmail(e.target.value)}
              className="border px-2 py-2 w-full rounded"
            />
          </div>

          <div>
            <label>Gender</label>
              value={division}<select
              value={gender}
              onChange={(e) => setGender(e.target.value)}
              className="border px-2 py-2 w-full rounded"
            >
              <option value="">-</option>
              <option value="male">Male</option>
              <option value="female">Female</option>
              <option value="other">Other</option>
            </select>
          </div>

          <div>
            <label>Address</label>
            <input
              value={address}
              onChange={(e) => setAddress(e.target.value)}
              className="border px-2 py-2 w-full rounded"
            />
          </div>

          {/* Dates */}
          <div>
            <label>
              DOB{" "}
              <span className="text-xs text-slate-500">(18+ required)</span>
            </label>
            <input
              type="date"
              value={dob}
              onChange={(e) => setDob(e.target.value)}
              className="border px-2 py-2 w-full rounded"
            />
          </div>

          <div>
            <label>DOJ</label>
            <input
              type="date"
              value={doj}
              onChange={(e) => setDoj(e.target.value)}
              className="border px-2 py-2 w-full rounded"
            />
          </div>

          {/* ID and Bank fields */}
          <div>
            <label>Aadhar</label>
            <input
              value={aadhar}
              onChange={(e) => setAadhar(e.target.value)}
              className="border px-2 py-2 w-full rounded"
            />
          </div>

          <div>
            <label>PAN</label>
            <input
              value={pan}
              onChange={(e) => setPan(e.target.value)}
              className="border px-2 py-2 w-full rounded"
            />
          </div>

          <div>
            <label>PF / TF</label>
            <input
              value={pfNumber}
              onChange={(e) => setPfNumber(e.target.value)}
              className="border px-2 py-2 w-full rounded"
            />
          </div>

          <div>
            <label>ESIC</label>
            <input
              value={esicNumber}
              onChange={(e) => setEsicNumber(e.target.value)}
              className="border px-2 py-2 w-full rounded"
            />
          </div>

          <div>
            <label>Bank Account</label>
            <input
              value={bankAccount}
              onChange={(e) => setBankAccount(e.target.value)}
              className="border px-2 py-2 w-full rounded"
            />
          </div>

          <div>
            <label>IFSC</label>
            <input
              value={ifsc}
              onChange={(e) => setIfsc(e.target.value)}
              className="border px-2 py-2 w-full rounded"
            />
          </div>

          <div>
            <label>Branch</label>
            <input
              value={bankBranch}
              onChange={(e) => setBankBranch(e.target.value)}
              className="border px-2 py-2 w-full rounded"
            />
          </div>

          {/* Zone / Division / Department */}
          <div>
            <label>Zone</label>
            <select
              value={zone}
              onChange={(e) => setZone(e.target.value)}
              className="border px-2 py-2 w-full rounded"
            >
              <option value="">—</option>
              {zones.map((z) => (
                <option key={z._id} value={z.name}>
                  {z.name}
                </option>
              ))}
            </select>
          </div>

          <div>
            <label>Division</label>
            <select
  multiple
  value={divisionsSelected}
  onChange={(e) =>
    setDivisionsSelected(
      Array.from(e.target.selectedOptions).map((o) => o.value)
    )
  }
  className="border px-2 py-2 w-full rounded h-32"
>

              <option value="">—</option>
              {divisions.map((d) => (
                <option key={d._id} value={d.name}>
                  {d.name}
                </option>
              ))}
            </select>
          </div>

          <div>
            <label>Department</label>
            <select
              value={department}
              onChange={(e) => setDepartment(e.target.value)}
              className="border px-2 py-2 w-full rounded"
            >
              <option value="">—</option>
              {departments.map((d) => (
                <option key={d._id} value={d.name}>
                  {d.name}
                </option>
              ))}
            </select>
          </div>

          {/* Documents */}
          <div className="col-span-3">
            <label className="text-sm">
              Documents (type + URL){" "}
              <span className="text-xs text-slate-500">
                (example: Aadhaar PDF, Google Drive link)
              </span>
            </label>

            {documents.map((d, idx) => (
              <div key={idx} className="flex gap-2 mb-2">
                <input
                  placeholder="type"
                  value={d.type}
                  onChange={(e) => setDocField(idx, "type", e.target.value)}
                  className="border rounded px-2 py-2 w-1/4"
                />
                <input
                  placeholder="url"
                  value={d.url}
                  onChange={(e) => setDocField(idx, "url", e.target.value)}
                  className="border rounded px-2 py-2 w-3/4"
                />
                <button
                  type="button"
                  onClick={() => removeDoc(idx)}
                  className="px-2 py-1 text-red-600 border rounded"
                >
                  Remove
                </button>
              </div>
            ))}

            <button
              type="button"
              onClick={addDoc}
              className="px-3 py-1 bg-sky-700 text-white text-sm rounded"
            >
              Add Document
            </button>
          </div>

          {/* Buttons */}
          <div className="col-span-3 flex gap-3 mt-4">
            <button className="px-4 py-2 bg-sky-700 text-white rounded">
              Create Supervisor
            </button>
            <button
              type="button"
              onClick={loadAll}
              className="px-4 py-2 border rounded"
            >
              Refresh
            </button>
          </div>
        </form>
      </section>

      {/* LIST */}
      <section className="bg-white p-4 rounded shadow">
        <h2 className="text-lg font-semibold mb-3">Supervisors List</h2>

        {loading ? (
          <div>Loading...</div>
        ) : (
          <table className="w-full text-sm">
            <thead>
              <tr className="text-left text-slate-600 border-b">
                <th className="p-2">Code</th>
                <th className="p-2">Name</th>
                <th className="p-2">Mobile</th>
                <th className="p-2">Zone</th>
                <th className="p-2">Division</th>
                <th className="p-2">Actions</th>
              </tr>
            </thead>

            <tbody>
              {list.map((s) => (
                <tr key={s.code} className="border-b">
                  <td className="p-2">{s.code}</td>
                  <td className="p-2">{s.name}</td>
                  <td className="p-2">{s.mobile}</td>
                  <td className="p-2">{s.zone}</td>
                  <td className="p-2">
  {Array.isArray(s.divisions) ? s.divisions.join(", ") : ""}
</td>


                  <td className="p-2 flex gap-2">
                    <button
                      onClick={() => editSupervisor(s.code)}
                      className="px-2 py-1 bg-yellow-500 text-white rounded text-xs"
                    >
                      Edit
                    </button>

                    <button
                      onClick={() => deleteSupervisor(s.code)}
                      className="px-2 py-1 bg-red-600 text-white rounded text-xs"
                    >
                      Delete
                    </button>

                    <button
                      onClick={() => assignEmployee(s.code)}
                      className="px-2 py-1 bg-blue-600 text-white rounded text-xs"
                    >
                      Assign
                    </button>
                  </td>
                </tr>
              ))}
            </tbody>
          </table>
        )}
      </section>
    </div>
  );
}
